# Synapse Feeder - ìµœì¢… ì„¤ê³„ë„

## ğŸ“‹ ëª©ì°¨
1. [ì‹œìŠ¤í…œ ê°œìš”](#ì‹œìŠ¤í…œ-ê°œìš”)
2. [ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨](#ì•„í‚¤í…ì²˜-ë‹¤ì´ì–´ê·¸ë¨)
3. [í•µì‹¬ ì„¤ê³„ ì›ì¹™](#í•µì‹¬-ì„¤ê³„-ì›ì¹™)
4. [ë ˆì´ì–´ë³„ ìƒì„¸ ì„¤ê³„](#ë ˆì´ì–´ë³„-ìƒì„¸-ì„¤ê³„)
5. [í´ë” êµ¬ì¡°](#í´ë”-êµ¬ì¡°)
6. [ì‹¤í–‰ íë¦„](#ì‹¤í–‰-íë¦„)
7. [ì—ëŸ¬ ì²˜ë¦¬ ì „ëµ](#ì—ëŸ¬-ì²˜ë¦¬-ì „ëµ)
8. [ë¦¬ì†ŒìŠ¤ í†µì œ](#ë¦¬ì†ŒìŠ¤-í†µì œ)
9. [ìš´ì˜ ê³ ë ¤ì‚¬í•­](#ìš´ì˜-ê³ ë ¤ì‚¬í•­)
10. [Python ì´ì‹ ê°€ì´ë“œ](#python-ì´ì‹-ê°€ì´ë“œ)

---

## ì‹œìŠ¤í…œ ê°œìš”

### ëª©ì 
**"ë§¤ì¼ ëŒì•„ê°€ì§€ë§Œ ì•„ë¬´ë„ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ì‹œìŠ¤í…œ"**ì„ ì‚¬ê³  ì—†ì´ êµ´ë¦¬ê¸° ìœ„í•œ Daily Crawling Automation ì‹œìŠ¤í…œ

### í•µì‹¬ ì² í•™
- **NodeëŠ” ë°°ì¹˜ ì‹¤í–‰ê¸°**: ìƒíƒœë¥¼ ê¸°ì–µí•˜ì§€ ì•ŠëŠ” ë‹¨ë°œ ì‹¤í–‰ í”„ë¡œì„¸ìŠ¤
- **ëª¨ë“  ë ˆì´ì–´ëŠ” ìˆœìˆ˜ í•¨ìˆ˜ + ê³„ì•½**: ëª…í™•í•œ ì¸í„°í˜ì´ìŠ¤ ê¸°ë°˜
- **ì¥ì• ëŠ” ê²©ë¦¬, ë³µêµ¬ëŠ” ì¬ì‹¤í–‰**: ë¶€ë¶„ ì‹¤íŒ¨ í—ˆìš©, cron ê¸°ë°˜ ìë™ ë³µêµ¬
- **Python ì „í™˜ ê°€ëŠ¥ì„±**: í´ë”/ê°œë… 1:1 ìœ ì§€ ê°€ëŠ¥í•œ êµ¬ì¡°

### ì‹¤í–‰ ëª¨ë¸
```
[ OS cron ]
    â†“
[ Node Single-run Process ]
    â†“
[ Execution Context ]
    â”œâ”€ Job Metadata (runId, date, tz)
    â”œâ”€ Logger
    â”œâ”€ Config (validated)
    â””â”€ Resource Limits
```

---

## ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
cron
 â””â”€ node dist/main.js
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Orchestrator         â”‚  main.ts / app.ts
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - ExecutionContext ìƒì„±     â”‚
â”‚ - Collector ìˆœíšŒ            â”‚
â”‚ - ì‹¤íŒ¨ ê²©ë¦¬                 â”‚
â”‚ - ê²°ê³¼ ì§‘ê³„                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Pipeline                       â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ 1. Collector Layer     (Raw ìƒì„±)               â”‚
â”‚ 2. Raw Storage         (ì¦ê±° ë³´ì¡´)              â”‚
â”‚ 3. Normalizer Layer    (Schema Gate)            â”‚
â”‚ 4. Normalized Storage  (ì‹ ë¢° ë°ì´í„°)            â”‚
â”‚ 5. Formatter Layer     (Human-readable)         â”‚
â”‚ 6. Notifier Layer      (Side Effect)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë ˆì´ì–´ ì˜ì¡´ì„± (ë‹¨ë°©í–¥)
```
Collector
   â†“
Normalizer
   â†“
Storage
   â†“
Formatter
   â†“
Notifier
```

**âŒ ì—­ë°©í–¥ import ê¸ˆì§€**
**âŒ ìˆœí™˜ ì˜ì¡´ ë°œìƒ ì‹œ ì¦‰ì‹œ ë¦¬íŒ©í† ë§**

---

## í•µì‹¬ ì„¤ê³„ ì›ì¹™

### 1ï¸âƒ£ ì‹œìŠ¤í…œ ìƒì¡´ì„± ì›ì¹™ (Operational Survivability)

#### ë¬´ì¸ ì‹¤í–‰ ì „ì œ ì›ì¹™
- ëª¨ë“  ì‹¤í–‰ì€ ë¹„ëŒ€í™”í˜• / ë¬´ìƒíƒœ
- ì‹¤í–‰ ì¤‘ ì¤‘ë‹¨ë˜ë©´ â†’ ë‹¤ìŒ cron ì‹¤í–‰ì´ ë³µêµ¬ ìˆ˜ë‹¨
- ë©”ëª¨ë¦¬Â·í”„ë¡œì„¸ìŠ¤ ìƒíƒœì— ì˜ì¡´ ê¸ˆì§€
- ì „ì—­ ì‹±ê¸€í†¤ ìƒíƒœ ê¸ˆì§€

#### ë¶€ë¶„ ì‹¤íŒ¨ í—ˆìš© ì›ì¹™ (Partial Failure Tolerance)
- ì„±ê³µ/ì‹¤íŒ¨ëŠ” "ì „ì²´"ê°€ ì•„ë‹ˆë¼ "ì†ŒìŠ¤ ë‹¨ìœ„"ë¡œ íŒë‹¨
- Collector A ì‹¤íŒ¨ â‰  Job ì‹¤íŒ¨
- ì‹¤íŒ¨í•œ ì†ŒìŠ¤ëŠ” ëª…ì‹œì ìœ¼ë¡œ ê¸°ë¡
- ì„±ê³µí•œ ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ë‚¨ê¹€

### 2ï¸âƒ£ ê²½ê³„ ì—„ê²©ì„± ì›ì¹™ (Hard Boundary Rule)

#### ë ˆì´ì–´ ì¹¨ë²” ì ˆëŒ€ ê¸ˆì§€
| ë ˆì´ì–´ | ì•Œë©´ ì•ˆ ë˜ëŠ” ê²ƒ |
|--------|----------------|
| Collector | Schema, DB, Slack |
| Normalizer | HTML, API êµ¬ì¡° |
| Storage | ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ë¯¸ |
| Formatter | Raw êµ¬ì¡° |
| Notifier | ë°ì´í„° êµ¬ì¡° |

### 3ï¸âƒ£ ê³„ì•½ ì¤‘ì‹¬ ì„¤ê³„ ì›ì¹™ (Contract-First Design)
- ëª¨ë“  ë ˆì´ì–´ëŠ” "ê³„ì•½"ì„ ë¨¼ì € ê°€ì§„ë‹¤
- interface / abstract class ì—†ì´ êµ¬í˜„ ì‹œì‘ âŒ
- ê³„ì•½ì´ ê³§ ë¬¸ì„œ

### 4ï¸âƒ£ ë°ì´í„° ë¬´ê²°ì„± ì›ì¹™ (Data Integrity Doctrine)

#### Raw ë°ì´í„°ëŠ” "ì¦ê±°(Evidence)"ë‹¤
- RawëŠ” ì ˆëŒ€ ê°€ê³µí•˜ì§€ ì•ŠëŠ”ë‹¤
- JSON stringify ê·¸ëŒ€ë¡œ ì €ì¥
- Rawê°€ ì—†ìœ¼ë©´ ì¥ì•  ì›ì¸ ì¶”ì  ë¶ˆê°€

#### ì •ê·œí™” ë°ì´í„°ëŠ” "ì‹ ë¢° ìì‚°(Asset)"ì´ë‹¤
- Normalizer í†µê³¼ ì „ ë°ì´í„° = ë¶ˆì‹ 
- í†µê³¼ í›„ ë°ì´í„° = ì¬ì‚¬ìš© ê°€ëŠ¥
- Schema Gate ë‹¨ì¼í™”

### 5ï¸âƒ£ ì‹œê°„ & ì¬ì‹¤í–‰ ì›ì¹™ (Temporal Safety)

#### Idempotency(ë©±ë“±ì„±) ë³´ì¥
- ê°™ì€ ë‚  Në²ˆ ì‹¤í–‰ë˜ì–´ë„ ê²°ê³¼ëŠ” ë™ì¼í•´ì•¼ í•œë‹¤
- ë‚ ì§œ + source ê¸°ì¤€ ì¤‘ë³µ ì œê±°
- DB insert ì‹œ unique key ê³ ë ¤
- Raw overwrite í—ˆìš©

#### ì‹œê°„ì€ í•­ìƒ ëª…ì‹œì 
- ì„œë²„ ë¡œì»¬ ì‹œê°„ âŒ
- UTC or ëª…ì‹œ TZ ì‚¬ìš©
- ëª¨ë“  ë‚ ì§œëŠ” ISO ë³€í™˜ í›„ ì €ì¥

### 6ï¸âƒ£ ë¦¬ì†ŒìŠ¤ í†µì œ ì›ì¹™ (Resource Discipline)

#### ì™¸ë¶€ ìì›ì€ ë°˜ë“œì‹œ ì œí•œí•œë‹¤
| ìì› | í•„ìˆ˜ ì œì–´ |
|------|----------|
| HTTP | timeout |
| í¬ë¡¤ë§ | retry íšŸìˆ˜ |
| Playwright | browser lifecycle |
| íŒŒì¼ | atomic write |

#### ë™ì‹œì„±ì€ ëª…ì‹œì ìœ¼ë¡œ ê´€ë¦¬
- Promise.all ë¬´ë¶„ë³„ ì‚¬ìš© âŒ
- Collector ë‹¨ìœ„ ì§ë ¬ ì‹¤í–‰ ê¸°ë³¸
- ë³‘ë ¬ì€ ì˜µì…˜ìœ¼ë¡œë§Œ í—ˆìš©

### 7ï¸âƒ£ ì¶œë ¥ ì±…ì„ ì›ì¹™ (Output Responsibility)
- FormatterëŠ” UX ì±…ì„ì„ ì§„ë‹¤
- ë°ì´í„° ë‚˜ì—´ âŒ, ë§¥ë½Â·ê·¸ë£¹Â·ìš”ì•½ í•„ìˆ˜
- NotifierëŠ” ê²°ê³¼ë¥¼ ë°”ê¾¸ì§€ ì•ŠëŠ”ë‹¤
- ì‹¤íŒ¨í•´ë„ ë°ì´í„° ì†ìƒ âŒ

### 8ï¸âƒ£ ë³€ê²½ ë‚´ì„± ì›ì¹™ (Change Resilience)
- ìƒˆ ì†ŒìŠ¤ ì¶”ê°€ ì‹œ ìˆ˜ì • íŒŒì¼ ìˆ˜ â‰¤ 1
- ì–¸ì–´ êµì²´ ê°€ëŠ¥ì„± ìœ ì§€ (TS â†’ Python)

### 9ï¸âƒ£ ê´€ì¸¡ ê°€ëŠ¥ì„± ì›ì¹™ (Observability)
- ëª¨ë“  ì‹¤íŒ¨ëŠ” ì‹ë³„ ê°€ëŠ¥í•´ì•¼ í•œë‹¤
- sourceName í¬í•¨ ë¡œê·¸
- ì‹¤í–‰ ë‚ ì§œ í¬í•¨
- Stack trace ë³´ì¡´
- ì„±ê³µë„ ê¸°ë¡í•œë‹¤

---

## ë ˆì´ì–´ë³„ ìƒì„¸ ì„¤ê³„

### 1ï¸âƒ£ Execution Context

#### êµ¬ì¡°
```typescript
interface ExecutionContext {
  runId: string;          // uuid
  runDate: string;        // YYYY-MM-DD (UTC)
  timezone: 'UTC';
  logger: Logger;
  config: AppConfig;
}
```

#### ì—­í• 
- ëª¨ë“  ë ˆì´ì–´ëŠ” Contextë¥¼ ì£¼ì…ë°›ëŠ”ë‹¤
- ì „ì—­ ì ‘ê·¼ âŒ
- Python ì´ì‹ ì‹œì—ë„ ê·¸ëŒ€ë¡œ ìœ ì§€ ê°€ëŠ¥

### 2ï¸âƒ£ Orchestrator (app.ts)

#### ì±…ì„
- íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ìˆœì„œ ì œì–´
- Collector ë‹¨ìœ„ ì‹¤íŒ¨ ê²©ë¦¬
- ê²°ê³¼ ì§‘ê³„

#### âŒ ê¸ˆì§€
- ë°ì´í„° ê°€ê³µ
- I/O ì§ì ‘ ì²˜ë¦¬
- Slack SDK ì ‘ê·¼

#### ì‹¤í–‰ íë¦„
```typescript
for (const collector of collectors) {
  try {
    const raw = await collector.collect(ctx);
    rawStore.save(ctx, collector.sourceName, raw);
    
    const normalized = normalizer.normalize(
      ctx,
      collector.sourceName,
      raw
    );
    
    repository.saveMany(ctx, normalized);
    executionResult.success(collector.sourceName, normalized.length);
  } catch (err) {
    executionResult.fail(collector.sourceName, err);
  }
}

const report = formatter.render(ctx, executionResult);
notifier.send(ctx, report);
```

### 3ï¸âƒ£ Collector Layer

#### ê³„ì•½
```typescript
interface BaseCollector {
  readonly sourceName: string;
  readonly policy?: CollectorPolicy;  // timeout, retry, rateLimit
  collect(ctx: ExecutionContext): Promise<RawRecord[]>;
}
```

#### Collector Policy
```typescript
interface CollectorPolicy {
  timeoutMs: number;        // Collector ì‹¤í–‰ ë‹¨ìœ„ íƒ€ì„ì•„ì›ƒ
  maxRetries: number;       // ì¬ì‹œë„ íšŸìˆ˜
  rateLimit?: {
    requestsPerSecond: number;
    minIntervalMs: number;
  };
}
```

#### ì›ì¹™
- ContextëŠ” ì½ê¸°ë§Œ ê°€ëŠ¥
- íŒŒì¼ ì €ì¥ âŒ
- schema âŒ
- Rate Limit / RetryëŠ” Collector ë‚´ë¶€ ì±…ì„

#### ë””ë ‰í† ë¦¬ êµ¬ì¡°
```
collectors/
 â”œâ”€ BaseCollector.ts   â† ê³„ì•½
 â”œâ”€ index.ts            â† registry
 â”œâ”€ web/
 â”‚   â”œâ”€ SiteACollector.ts
 â”‚   â””â”€ SiteBCollector.ts
 â””â”€ api/
     â””â”€ ApiBCollector.ts
```

#### Collector ì˜ˆì‹œ
```typescript
export class SiteACollector implements BaseCollector {
  readonly sourceName = 'site_a';
  
  readonly policy: CollectorPolicy = {
    timeoutMs: 8_000,
    maxRetries: 2,
    rateLimit: {
      requestsPerSecond: 3,
      minIntervalMs: 1000,
    },
  };
  
  async collect(ctx: ExecutionContext): Promise<RawRecord[]> {
    // HTTP / íŒŒì‹±ê¹Œì§€ë§Œ
    // ë‚ ì§œ ë³€í™˜ âŒ
    // í•„ë“œ ë³´ì • âŒ
    // null ì²˜ë¦¬ âŒ
  }
}
```

### 4ï¸âƒ£ Raw Storage Layer

#### ì±…ì„
- atomic write
- ë‚ ì§œ/ì†ŒìŠ¤ ê¸°ì¤€ ë¶„ë¦¬
- overwrite í—ˆìš©

#### ì‚¬ìš©ë²•
```typescript
rawStore.save(ctx, sourceName, raw);
```

#### ì €ì¥ ê²½ë¡œ
```
data/raw/YYYY-MM-DD/{sourceName}.json
```

#### ì›ì¹™
- RawëŠ” ì¬ì²˜ë¦¬ ì „ìš©
- Formatter / Notifier ì ‘ê·¼ ê¸ˆì§€
- JSON ê·¸ëŒ€ë¡œ ì €ì¥, ë³€í˜• âŒ

### 5ï¸âƒ£ Normalizer Layer (Single Schema Gate)

#### êµ¬ì¡°
```
normalizers/
 â”œâ”€ schemas/
 â”‚   â””â”€ Article.schema.ts
 â”œâ”€ article.normalizer.ts
 â””â”€ utils/
     â”œâ”€ parseDate.ts
     â””â”€ sanitizeHtml.ts
```

#### Schema ì •ì˜
```typescript
export const ArticleSchema = z.object({
  source: z.string().min(1),
  title: z.string().min(1),
  url: z.string().url(),
  publishedAt: z.date(),
  content: z.string().min(1),
});

export type Article = z.infer<typeof ArticleSchema>;
```

#### ì›ì¹™
- zod ì‚¬ìš© ìœ„ì¹˜ ë‹¨ 1ê³³
- ì‹¤íŒ¨ ì‹œ ì˜ˆì™¸ throw
- Collectorë³„ mappingì€ ì—¬ê¸°ì„œ ì²˜ë¦¬
- Python ë¦¬íŒ©í† ë§ ì‹œ pydantic 1:1 ëŒ€ì‘

#### Normalize í•¨ìˆ˜
```typescript
export function normalize(
  ctx: ExecutionContext,
  sourceName: string,
  raw: RawRecord[]
): Article[] {
  return rawList.map((raw, index) => {
    try {
      return ArticleSchema.parse({
        source: sourceName,
        title: raw['title'],
        url: raw['url'],
        publishedAt: parseDate(raw['publishedAt'] ?? raw['date']),
        content: sanitizeHtml(raw['content']),
      });
    } catch (err) {
      throw new NormalizeError(sourceName, raw, index, err);
    }
  });
}
```

### 6ï¸âƒ£ Normalized Storage Layer (Repository)

#### êµ¬ì¡°
```
storage/
 â”œâ”€ repository/
 â”‚   â”œâ”€ ArticleRepository.ts      â† interface
 â”‚   â”œâ”€ SQLiteArticleRepository.ts â† êµ¬í˜„
 â”‚   â””â”€ index.ts
 â””â”€ db/
     â”œâ”€ client.ts
     â””â”€ migrations/
         â””â”€ 001_init.sql
```

#### Repository Interface
```typescript
export interface ArticleRepository {
  saveMany(ctx: ExecutionContext, articles: Article[]): Promise<void>;
}
```

#### ì±…ì„
- ë©±ë“±ì„± ë³´ì¥
- ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ë¯¸ ì—†ìŒ
- unique key: (source, url)

#### DB Schema
```sql
CREATE TABLE IF NOT EXISTS articles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  source TEXT NOT NULL,
  title TEXT NOT NULL,
  url TEXT NOT NULL,
  published_at TEXT NOT NULL,
  content TEXT NOT NULL,
  created_at TEXT NOT NULL,
  UNIQUE (source, url)
);
```

### 7ï¸âƒ£ Formatter Layer

#### êµ¬ì¡°
```
formatter/
 â”œâ”€ templates/
 â”‚   â””â”€ daily-report.hbs
 â”œâ”€ DailyReportFormatter.ts
 â””â”€ index.ts
```

#### ì…ë ¥
- ExecutionResult (ì„±ê³µ/ì‹¤íŒ¨ ì§‘ê³„)
- Article list

#### ì¶œë ¥
- Markdown string (Slackìš©)

#### ì›ì¹™
- FormatterëŠ” ì‹¤íŒ¨/ì„±ê³µì„ ìˆ¨ê¸°ì§€ ì•ŠëŠ”ë‹¤
- ì‹¤íŒ¨ sourceë„ ë¦¬í¬íŠ¸ì— í‘œì‹œ
- ë¹„ì¦ˆë‹ˆìŠ¤ íŒë‹¨ âŒ
- ì •ë ¬/ê·¸ë£¹í™”ëŠ” í—ˆìš© (í‘œí˜„ ëª©ì )

### 8ï¸âƒ£ Notifier Layer

#### êµ¬ì¡°
```
notifier/
 â”œâ”€ Notifier.ts         â† interface
 â”œâ”€ SlackNotifier.ts
 â””â”€ index.ts
```

#### ì›ì¹™
- ë°ì´í„° ë³€ê²½ âŒ
- ì‹¤íŒ¨ throw âŒ
- Slack ì‹¤íŒ¨ëŠ” ì‹œìŠ¤í…œ ì‹¤íŒ¨ ì•„ë‹˜

#### ì•ˆì „ í˜¸ì¶œ
```typescript
async function safeNotify(
  notifier: Notifier,
  ctx: ExecutionContext,
  message: string
) {
  try {
    await notifier.send(ctx, message);
  } catch (e) {
    ctx.logger.error('[NOTIFY_FAIL]', e);
    // ì ˆëŒ€ throw ê¸ˆì§€
  }
}
```

### 9ï¸âƒ£ Config & Validation

#### êµ¬ì¡°
```
config/
 â”œâ”€ env.schema.ts       # zod í™˜ê²½ë³€ìˆ˜ ìŠ¤í‚¤ë§ˆ
 â””â”€ index.ts            # env ë¡œë“œ + ê²€ì¦
```

#### ì›ì¹™
- zod ê¸°ë°˜ ê²€ì¦
- ì‹¤í–‰ ì´ˆê¸°ì—ë§Œ ë¡œë“œ
- ì„¤ì • ì—ëŸ¬ = ì¦‰ì‹œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ

---

## í´ë” êµ¬ì¡°

```
project-root/
â”œâ”€ package.json
â”œâ”€ tsconfig.json
â”œâ”€ .env
â”œâ”€ .env.example
â”œâ”€ .gitignore
â”œâ”€ README.md
â”‚
â”œâ”€ src/
â”‚  â”œâ”€ main.ts                # Entry Point (node dist/main.js)
â”‚  â”œâ”€ app.ts                 # Orchestrator (íŒŒì´í”„ë¼ì¸ ì¡°ë¦½)
â”‚  â”‚
â”‚  â”œâ”€ config/
â”‚  â”‚  â”œâ”€ env.schema.ts       # zod í™˜ê²½ë³€ìˆ˜ ìŠ¤í‚¤ë§ˆ
â”‚  â”‚  â””â”€ index.ts            # env ë¡œë“œ + ê²€ì¦
â”‚  â”‚
â”‚  â”œâ”€ collectors/
â”‚  â”‚  â”œâ”€ BaseCollector.ts    # ìˆ˜ì§‘ ê³„ì•½ (interface)
â”‚  â”‚  â”œâ”€ index.ts            # collector registry
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ web/
â”‚  â”‚  â”‚  â”œâ”€ SiteACollector.ts
â”‚  â”‚  â”‚  â””â”€ SiteBCollector.ts
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ api/
â”‚  â”‚     â””â”€ ApiBCollector.ts
â”‚  â”‚
â”‚  â”œâ”€ normalizers/
â”‚  â”‚  â”œâ”€ schemas/
â”‚  â”‚  â”‚  â””â”€ Article.schema.ts   # zod schema
â”‚  â”‚  â”œâ”€ article.normalizer.ts
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ utils/
â”‚  â”‚     â”œâ”€ parseDate.ts
â”‚  â”‚     â””â”€ sanitizeHtml.ts
â”‚  â”‚
â”‚  â”œâ”€ storage/
â”‚  â”‚  â”œâ”€ raw/
â”‚  â”‚  â”‚  â”œâ”€ RawStorage.ts    # fs ê¸°ë°˜ raw ì €ì¥
â”‚  â”‚  â”‚  â””â”€ index.ts
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ repository/
â”‚  â”‚  â”‚  â”œâ”€ ArticleRepository.ts
â”‚  â”‚  â”‚  â”œâ”€ SQLiteArticleRepository.ts
â”‚  â”‚  â”‚  â””â”€ index.ts
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ db/
â”‚  â”‚     â”œâ”€ client.ts        # sqlite ì—°ê²°
â”‚  â”‚     â””â”€ migrations/
â”‚  â”‚        â””â”€ 001_init.sql
â”‚  â”‚
â”‚  â”œâ”€ formatter/
â”‚  â”‚  â”œâ”€ formatReport.ts
â”‚  â”‚  â”œâ”€ templates/
â”‚  â”‚  â”‚  â””â”€ daily-report.hbs
â”‚  â”‚  â””â”€ index.ts
â”‚  â”‚
â”‚  â”œâ”€ notifier/
â”‚  â”‚  â”œâ”€ Notifier.ts         # interface
â”‚  â”‚  â”œâ”€ SlackNotifier.ts
â”‚  â”‚  â””â”€ index.ts
â”‚  â”‚
â”‚  â”œâ”€ errors/
â”‚  â”‚  â”œâ”€ AppError.ts
â”‚  â”‚  â”œâ”€ CollectorError.ts
â”‚  â”‚  â””â”€ NormalizeError.ts
â”‚  â”‚
â”‚  â”œâ”€ logger/
â”‚  â”‚  â”œâ”€ index.ts
â”‚  â”‚  â””â”€ format.ts
â”‚  â”‚
â”‚  â”œâ”€ types/
â”‚  â”‚  â””â”€ Article.ts          # zod infer ì¬export (ì„ íƒ)
â”‚  â”‚
â”‚  â””â”€ utils/
â”‚     â”œâ”€ withTimeout.ts
â”‚     â”œâ”€ retry.ts
â”‚     â””â”€ rateLimiter.ts
â”‚
â”œâ”€ data/
â”‚  â”œâ”€ raw/
â”‚  â”‚  â””â”€ YYYY-MM-DD/
â”‚  â”‚     â””â”€ {sourceName}.json
â”‚  â””â”€ articles.db
â”‚
â”œâ”€ dist/                     # ts ë¹Œë“œ ê²°ê³¼
â”‚
â””â”€ scripts/
   â””â”€ run-local.sh           # ë¡œì»¬ ì‹¤í–‰ìš©
```

---

## ì‹¤í–‰ íë¦„

### 1. Entry Point (main.ts)
```typescript
import { runApp } from './app';

runApp()
  .then(() => process.exit(0))
  .catch(err => {
    console.error(err);
    process.exit(1);
  });
```

### 2. Orchestrator (app.ts)
```typescript
export async function runApp() {
  // 1. Context ìƒì„±
  const ctx = createExecutionContext();
  
  // 2. ì»´í¬ë„ŒíŠ¸ ë¡œë“œ
  const collectors = loadCollectors();
  const repository = loadRepository();
  const formatter = loadFormatter();
  const notifier = loadNotifier();
  
  // 3. ì‹¤í–‰ ê²°ê³¼ ì§‘ê³„
  const executionResult = new ExecutionResult();
  
  // 4. Collector ìˆœíšŒ
  for (const collector of collectors) {
    try {
      // Timeout ì ìš©
      const raw = await withTimeout(
        collector.collect(ctx),
        collector.policy?.timeoutMs ?? 30_000
      );
      
      // Raw ì €ì¥
      await rawStore.save(ctx, collector.sourceName, raw);
      
      // ì •ê·œí™”
      const normalized = normalizer.normalize(
        ctx,
        collector.sourceName,
        raw
      );
      
      // DB ì €ì¥
      await repository.saveMany(ctx, normalized);
      
      executionResult.success(collector.sourceName, normalized.length);
      
    } catch (err) {
      executionResult.fail(collector.sourceName, err);
      // ì—ëŸ¬ ì•Œë¦¼ (ë³„ë„ ì±„ë„)
      await errorNotifier.notify(ctx, collector.sourceName, err);
    }
  }
  
  // 5. ë¦¬í¬íŠ¸ ìƒì„± & ì „ì†¡
  const report = formatter.render(ctx, executionResult);
  await safeNotify(notifier, ctx, report);
}
```

---

## ì—ëŸ¬ ì²˜ë¦¬ ì „ëµ

### ì¥ì•  ì„¤ê³„ ë§¤í•‘

| ìƒí™© | ì²˜ë¦¬ |
|------|------|
| Collector ì‹¤íŒ¨ | í•´ë‹¹ source ìŠ¤í‚µ, ì—ëŸ¬ ë¡œê·¸, ë‹¤ìŒ Collector ì§„í–‰ |
| Normalize ì‹¤íŒ¨ | í•´ë‹¹ source ìŠ¤í‚µ, Raw ë³´ì¡´, ì—ëŸ¬ ë¡œê·¸ |
| DB ì‹¤íŒ¨ | í”„ë¡œì„¸ìŠ¤ ì‹¤íŒ¨ (ë°ì´í„° ì†ì‹¤ ë°©ì§€) |
| Slack ì‹¤íŒ¨ | ë¡œê·¸ë§Œ, í”„ë¡œì„¸ìŠ¤ ì„±ê³µ ìœ ì§€ |
| í”„ë¡œì„¸ìŠ¤ í¬ë˜ì‹œ | cron ì¬ì‹œì‘ |

### ì—ëŸ¬ íƒ€ì…

```typescript
// Collector ì—ëŸ¬
class CollectorError extends AppError {
  constructor(
    public sourceName: string,
    public originalError: unknown
  ) {}
}

// Normalize ì—ëŸ¬
class NormalizeError extends AppError {
  constructor(
    public sourceName: string,
    public rawData: unknown,
    public index: number,
    public originalError: unknown
  ) {}
}
```

### ì—ëŸ¬ ì•Œë¦¼ ë¶„ë¦¬

**ë³´ê³ ìš© Slack**ê³¼ **ì¥ì•  Slack**ì€ ì ˆëŒ€ ì„ì§€ ì•ŠëŠ”ë‹¤

```typescript
// ì¥ì•  ì „ìš© ì•Œë¦¼
await errorNotifier.notify({
  source: collector.sourceName,
  stage: 'collect' | 'normalize' | 'storage',
  error: err,
  runId: ctx.runId,
});
```

---

## ë¦¬ì†ŒìŠ¤ í†µì œ

### 1. Timeout ì„¤ê³„

#### ì›ì¹™
- Timeoutì€ Collectorì˜ "ëŠ¥ë ¥ì¹˜"
- Collectorë§ˆë‹¤ í•˜ë“œ ìƒí•œ
- ìš”ì²­ ë‹¨ìœ„ê°€ ì•„ë‹ˆë¼ Collector ì‹¤í–‰ ë‹¨ìœ„
- OrchestratorëŠ” ì‹œê°„ ì´ˆê³¼ ì—¬ë¶€ë§Œ íŒë‹¨

#### Timeout ê³„ì¸µ êµ¬ì¡°
```
Collector timeout (ìµœìƒìœ„)
 â””â”€ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ timeout
     â””â”€ page.goto timeout
```

#### ê¶Œì¥ Timeout ê¸°ì¤€í‘œ
| ìœ í˜• | ê¶Œì¥ Timeout |
|------|-------------|
| ê³µê³µ API | 3~5ì´ˆ |
| ë‚´ë¶€ API | 2~3ì´ˆ |
| ì •ì  HTML | 5~8ì´ˆ |
| ë¡œê·¸ì¸ í•„ìš” | 10~15ì´ˆ |
| Playwright | 20~30ì´ˆ (ìƒí•œ) |

### 2. Retry ì „ëµ

#### Retry ì¡°ê±´
| ìƒí™© | Retry |
|------|-------|
| ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ | âœ… |
| 429 (Too Many Requests) | âœ… |
| 5xx | âœ… |
| 4xx (400, 404) | âŒ |
| íŒŒì‹± ì˜¤ë¥˜ | âŒ |
| normalize ì‹¤íŒ¨ | âŒ |

#### RetryëŠ” Collector ë‚´ë¶€ ì±…ì„
```typescript
async collect() {
  return retry(
    async () => {
      const res = await axios.get(this.url, { timeout: 10_000 });
      return res.data.items;
    },
    {
      retries: 3,
      backoffMs: 1000,
      retryOn: isRetryableHttpError,
    }
  );
}
```

### 3. Rate Limit ì •ì±…

#### ì›ì¹™
- âŒ ì „ì—­ rate limit
- âœ… Collectorë§ˆë‹¤ ëª…ì‹œì  ì •ì±… ë³´ìœ 
- âœ… Python ì „í™˜ ì‹œ 1:1 ì´ì‹ ê°€ëŠ¥

#### Rate Limitì€ Collectorì˜ ì±…ì„
```typescript
export class SiteACollector implements BaseCollector {
  readonly policy: CollectorPolicy = {
    timeoutMs: 8_000,
    maxRetries: 2,
    rateLimit: {
      requestsPerSecond: 3,
      minIntervalMs: 1000,
    },
  };
  
  private limiter = new RateLimiter(this.policy.rateLimit);
  
  async collect() {
    await this.limiter.waitIfNeeded();
    // ...
  }
}
```

---

## ìš´ì˜ ê³ ë ¤ì‚¬í•­

### 1. ë°°í¬ êµ¬ì¡°

#### Docker + cron ì»¨í…Œì´ë„ˆ
```dockerfile
FROM node:20-slim

# cron ì„¤ì¹˜
RUN apt-get update && apt-get install -y cron && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# ì˜ì¡´ì„±
COPY package*.json ./
RUN npm ci

# ì†ŒìŠ¤
COPY . .

# ë¹Œë“œ
RUN npm run build

# cron ë“±ë¡
COPY docker/crontab /etc/cron.d/daily-crawler
RUN chmod 0644 /etc/cron.d/daily-crawler && crontab /etc/cron.d/daily-crawler

CMD ["cron", "-f"]
```

#### Cron ì„¤ì •
```
SHELL=/bin/bash
PATH=/usr/local/bin:/usr/bin:/bin

0 6 * * * node /app/dist/main.js >> /var/log/crawler.log 2>&1
```

### 2. ë¡œê¹… ì „ëµ

#### ë¡œê·¸ í¬ë§·
```
[INFO] ğŸš€ Daily crawling job started
[INFO] ğŸ” Collecting from site_a
[INFO] âœ… site_a: 15 items
[ERROR] [CollectorFailed] source=site_b error=TimeoutError
[INFO] ğŸ“¨ Slack report sent
[INFO] ğŸ Daily crawling job finished
```

#### ë¡œê·¸ í¬í•¨ ì •ë³´
- sourceName
- ì‹¤í–‰ ë‚ ì§œ
- Stack trace (ì—ëŸ¬ ì‹œ)

### 3. ëª¨ë‹ˆí„°ë§

#### ê´€ì¸¡ ê°€ëŠ¥ì„±
- ëª¨ë“  ì‹¤íŒ¨ëŠ” ì‹ë³„ ê°€ëŠ¥
- ì„±ê³µë„ ê¸°ë¡
- ì‹¤í–‰ ì‹œê°„ ì¸¡ì •
- ìˆ˜ì§‘ ê±´ìˆ˜ ì§‘ê³„

#### Slack ì•Œë¦¼ ë¶„ë¦¬
- **ë³´ê³ ìš© Slack**: ì¼ì¼ ë¦¬í¬íŠ¸ (ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ í¬í•¨)
- **ì¥ì•  Slack**: ì¦‰ì‹œ ì•Œë¦¼ (ì—ëŸ¬ ë°œìƒ ì‹œ)

---

## Python ì´ì‹ ê°€ì´ë“œ

### 1:1 ëŒ€ì‘í‘œ

| TypeScript | Python |
|------------|--------|
| `interface BaseCollector` | `ABC + abstractmethod` |
| `Record<string, unknown>` | `dict[str, Any]` |
| `zod schema` | `pydantic BaseModel` |
| `normalizeArticles` | `Model.parse_obj` |
| `fs/promises` | `pathlib / json` |
| `better-sqlite3` | `SQLAlchemy` |
| `handlebars` | `jinja2` |
| `cron` | `cron` |
| `app.ts` | `main.py` |

### ì´ì‹ ì „ëµ

1. **Collector ê·¸ëŒ€ë¡œ**: êµ¬ì¡° ìœ ì§€
2. **Normalizer ë¨¼ì €**: Schema Gateë¶€í„°
3. **Storage ë§ˆì§€ë§‰**: DB ì—°ê²°
4. **Slackì€ ìµœí›„**: ë¶€ìˆ˜ íš¨ê³¼

### í´ë” êµ¬ì¡° ìœ ì§€
```
collectors/     â†’ collectors/
normalizers/    â†’ schemas/
storage/        â†’ storage/
formatter/      â†’ templates/
```

---

## ì¥ì•  & ìš´ì˜ ëŒ€ì‘ ë§¤í•‘

| ì„¤ê³„ ì›ì¹™ | ì•„í‚¤í…ì²˜ ë°˜ì˜ |
|-----------|--------------|
| ë¬´ì¸ ì‹¤í–‰ | cron + ë‹¨ë°œ |
| ë¶€ë¶„ ì‹¤íŒ¨ | Collector try/catch |
| Raw ë³´ì¡´ | RawStore |
| ë©±ë“±ì„± | Repository (UNIQUE key) |
| ê´€ì¸¡ ê°€ëŠ¥ì„± | ExecutionResult |
| ë³€ê²½ ë‚´ì„± | Collector ë…ë¦½ |

---

## í•µì‹¬ ìš”ì•½

ì´ ì•„í‚¤í…ì²˜ëŠ” **"ì˜¤ëŠ˜ì€ ì˜ ëëŠ”ë°, í•œ ë‹¬ ë’¤ë¶€í„° ì´ìœ  ì—†ì´ ê¹¨ì§€ëŠ” ìë™í™”"**ë¥¼ ì›ì²œ ì°¨ë‹¨í•˜ê¸° ìœ„í•œ êµ¬ì¡°ë‹¤.

### í•µì‹¬ íŠ¹ì§•
1. âœ… **ë¬´ì¸ ì‹¤í–‰**: cron ê¸°ë°˜ ë‹¨ë°œ ì‹¤í–‰, ìƒíƒœ ì—†ìŒ
2. âœ… **ë¶€ë¶„ ì‹¤íŒ¨ í—ˆìš©**: Collector ë‹¨ìœ„ ê²©ë¦¬
3. âœ… **ì¦ê±° ë³´ì¡´**: Raw ë°ì´í„° ì €ì¥
4. âœ… **ì‹ ë¢° ë°ì´í„°**: Normalizer í†µê³¼ í›„ë§Œ ì €ì¥
5. âœ… **í™•ì¥ì„±**: ìƒˆ ì†ŒìŠ¤ ì¶”ê°€ ì‹œ íŒŒì¼ 1ê°œë§Œ ìˆ˜ì •
6. âœ… **ì´ì‹ì„±**: Python ì „í™˜ ì‹œ êµ¬ì¡° ìœ ì§€
7. âœ… **ê´€ì¸¡ ê°€ëŠ¥**: ëª¨ë“  ì‹¤íŒ¨/ì„±ê³µ ê¸°ë¡

### í•œ ì¤„ ì •ì˜
**"ë§¤ì¼ ëŒì•„ê°€ì§€ë§Œ ì•„ë¬´ë„ ê´€ë¦¬í•˜ì§€ ì•ŠëŠ” ì‹œìŠ¤í…œ"ì„ ì‚¬ê³  ì—†ì´ êµ´ë¦¬ê¸° ìœ„í•´ ì„¤ê³„ëœ êµ¬ì¡°**
